# Decision Gate Enterprise System-Test Registry
# Maps enterprise system-tests to categories and priorities.
# Used by: scripts/test_runner.py, scripts/coverage_report.py

# =============================================================================
# Test Categories
# =============================================================================

[categories]
config = { description = "Enterprise configuration wiring and limits", quick = true }
security = { description = "Authz, TLS, and registry ACL enforcement", quick = true }
tenancy = { description = "Tenant isolation boundaries", quick = true }
usage = { description = "Usage metering, quotas, and idempotency", quick = true }
audit = { description = "Audit chain, JSONL export, and deny-path coverage", quick = true }
storage_postgres = { description = "Postgres store durability and integrity", quick = false }
storage_s3 = { description = "S3 runpack storage integrity", quick = false }
runpack = { description = "Runpack archive hardening", quick = false }
mcp_transport = { description = "Enterprise MCP transport parity and TLS", quick = false }
recovery = { description = "Backup and restore validation", quick = false }

# =============================================================================
# P0: Must Pass
# =============================================================================

[[tests]]
name = "enterprise_config_wiring_postgres_s3"
category = "config"
priority = "P0"
description = "Enterprise config wiring for Postgres run state + schema registry and S3 runpack storage."
files = ["enterprise/enterprise-system-tests/tests/config_wiring.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test config_wiring -- --exact enterprise_config_wiring_postgres_s3"
artifacts = ["summary.json", "summary.md", "tool_transcript.json"]
estimated_runtime_sec = 35

[[tests]]
name = "enterprise_tenant_authz_core_matrix"
category = "security"
priority = "P0"
description = "Tenant authz core matrix covering missing tenant, namespace allowlist, multi-tenant scopes, and registry ACL denial."
files = ["enterprise/enterprise-system-tests/tests/tenant_authz.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test tenant_authz -- --exact enterprise_tenant_authz_core_matrix"
artifacts = ["summary.json", "summary.md", "tool_transcript.json"]
estimated_runtime_sec = 15

[[tests]]
name = "enterprise_tenant_authz_jwt_subject_mapping"
category = "security"
priority = "P0"
description = "Tenant authz mapping for JWT/mTLS subjects."
files = ["enterprise/enterprise-system-tests/tests/tenant_authz.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test tenant_authz -- --exact enterprise_tenant_authz_jwt_subject_mapping"
artifacts = ["summary.json", "summary.md", "tool_transcript.json"]
estimated_runtime_sec = 10

[[tests]]
name = "tenant_isolation_across_components"
category = "tenancy"
priority = "P0"
description = "Run state, schema registry, and runpack storage isolation across tenants."
files = ["enterprise/enterprise-system-tests/tests/tenant_isolation.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test tenant_isolation -- --exact tenant_isolation_across_components"
artifacts = ["summary.json", "summary.md", "tool_transcript.json"]
estimated_runtime_sec = 25

[[tests]]
name = "usage_metering_tool_call_matrix"
category = "usage"
priority = "P0"
description = "Usage metering emits counters for every tool."
files = ["enterprise/enterprise-system-tests/tests/usage.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test usage -- --exact usage_metering_tool_call_matrix"
artifacts = ["summary.json", "summary.md", "tool_transcript.json"]
estimated_runtime_sec = 25

[[tests]]
name = "usage_idempotency_request_id"
category = "usage"
priority = "P0"
description = "Usage idempotency enforced via request_id."
files = ["enterprise/enterprise-system-tests/tests/usage.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test usage -- --exact usage_idempotency_request_id"
artifacts = ["summary.json", "summary.md", "tool_transcript.json"]
estimated_runtime_sec = 12

[[tests]]
name = "usage_quota_deny_before_mutation"
category = "usage"
priority = "P0"
description = "Quota denial prevents state mutation."
files = ["enterprise/enterprise-system-tests/tests/usage.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test usage -- --exact usage_quota_deny_before_mutation"
artifacts = ["summary.json", "summary.md", "tool_transcript.json"]
estimated_runtime_sec = 12

[[tests]]
name = "audit_chain_immutability"
category = "audit"
priority = "P0"
description = "Audit hash chain detects tampering."
files = ["enterprise/enterprise-system-tests/tests/audit.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test audit -- --exact audit_chain_immutability"
artifacts = ["summary.json", "summary.md", "tool_transcript.json", "audit.jsonl"]
estimated_runtime_sec = 12

[[tests]]
name = "audit_event_completeness"
category = "audit"
priority = "P0"
description = "Audit events include required fields for authz, usage, and registry."
files = ["enterprise/enterprise-system-tests/tests/audit.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test audit -- --exact audit_event_completeness"
artifacts = ["summary.json", "summary.md", "tool_transcript.json", "audit.jsonl"]
estimated_runtime_sec = 12

[[tests]]
name = "postgres_store_run_state_roundtrip"
category = "storage_postgres"
priority = "P0"
description = "Postgres run state roundtrip with version increments."
files = ["enterprise/enterprise-system-tests/tests/postgres_store.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test postgres_store -- --exact postgres_store_run_state_roundtrip"
artifacts = ["summary.json", "summary.md", "tool_transcript.json"]
estimated_runtime_sec = 20

[[tests]]
name = "postgres_store_corruption_detection"
category = "storage_postgres"
priority = "P0"
description = "Postgres corruption detection via hash mismatch."
files = ["enterprise/enterprise-system-tests/tests/postgres_store.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test postgres_store -- --exact postgres_store_corruption_detection"
artifacts = ["summary.json", "summary.md", "tool_transcript.json"]
estimated_runtime_sec = 18

[[tests]]
name = "s3_runpack_store_roundtrip"
category = "storage_s3"
priority = "P0"
description = "S3 runpack store roundtrip and integrity."
files = ["enterprise/enterprise-system-tests/tests/s3_runpack_store.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test s3_runpack_store -- --exact s3_runpack_store_roundtrip"
artifacts = ["summary.json", "summary.md", "tool_transcript.json"]
estimated_runtime_sec = 25

[[tests]]
name = "s3_runpack_metadata_tamper"
category = "storage_s3"
priority = "P0"
description = "S3 runpack metadata tamper detection."
files = ["enterprise/enterprise-system-tests/tests/s3_runpack_store.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test s3_runpack_store -- --exact s3_runpack_metadata_tamper"
artifacts = ["summary.json", "summary.md", "tool_transcript.json"]
estimated_runtime_sec = 25

[[tests]]
name = "runpack_archive_path_traversal"
category = "runpack"
priority = "P0"
description = "Runpack archive path traversal rejection."
files = ["enterprise/enterprise-system-tests/tests/s3_runpack_store.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test s3_runpack_store -- --exact runpack_archive_path_traversal"
artifacts = ["summary.json", "summary.md", "tool_transcript.json"]
estimated_runtime_sec = 20

[[tests]]
name = "runpack_archive_symlink_specials"
category = "runpack"
priority = "P0"
description = "Runpack archive symlink/special entry rejection."
files = ["enterprise/enterprise-system-tests/tests/s3_runpack_store.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test s3_runpack_store -- --exact runpack_archive_symlink_specials"
artifacts = ["summary.json", "summary.md", "tool_transcript.json"]
estimated_runtime_sec = 20

# =============================================================================
# P1: High Priority
# =============================================================================

[[tests]]
name = "usage_quota_scope_tenant_namespace"
category = "usage"
priority = "P1"
description = "Quota scope behavior across tenant vs namespace."
files = ["enterprise/enterprise-system-tests/tests/usage.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test usage -- --exact usage_quota_scope_tenant_namespace"
artifacts = ["summary.json", "summary.md", "tool_transcript.json"]
estimated_runtime_sec = 12

[[tests]]
name = "usage_rate_limit_tenant_token"
category = "security"
priority = "P1"
description = "Rate limiting per tenant and per token."
files = ["enterprise/enterprise-system-tests/tests/usage.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test usage -- --exact usage_rate_limit_tenant_token"
artifacts = ["summary.json", "summary.md", "tool_transcript.json"]
estimated_runtime_sec = 15

[[tests]]
name = "quota_evasion_concurrency"
category = "usage"
priority = "P1"
description = "Quota evasion under concurrency."
files = ["enterprise/enterprise-system-tests/tests/usage.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test usage -- --exact quota_evasion_concurrency"
artifacts = ["summary.json", "summary.md", "tool_transcript.json"]
estimated_runtime_sec = 15

[[tests]]
name = "usage_ledger_corruption"
category = "usage"
priority = "P1"
description = "Usage ledger corruption fails closed."
files = ["enterprise/enterprise-system-tests/tests/usage.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test usage -- --exact usage_ledger_corruption"
artifacts = ["summary.json", "summary.md", "tool_transcript.json"]
estimated_runtime_sec = 12

[[tests]]
name = "audit_export_jsonl_format"
category = "audit"
priority = "P1"
description = "Audit export JSONL format stability."
files = ["enterprise/enterprise-system-tests/tests/audit.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test audit -- --exact audit_export_jsonl_format"
artifacts = ["summary.json", "summary.md", "tool_transcript.json", "audit.jsonl"]
estimated_runtime_sec = 12

[[tests]]
name = "audit_deny_paths_coverage"
category = "audit"
priority = "P1"
description = "Audit logs for deny paths (authz/usage)."
files = ["enterprise/enterprise-system-tests/tests/audit.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test audit -- --exact audit_deny_paths_coverage"
artifacts = ["summary.json", "summary.md", "tool_transcript.json", "audit.jsonl"]
estimated_runtime_sec = 12

[[tests]]
name = "postgres_store_concurrent_writes"
category = "storage_postgres"
priority = "P1"
description = "Postgres concurrent writes are atomic."
files = ["enterprise/enterprise-system-tests/tests/postgres_store.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test postgres_store -- --exact postgres_store_concurrent_writes"
artifacts = ["summary.json", "summary.md", "tool_transcript.json"]
estimated_runtime_sec = 22

[[tests]]
name = "postgres_registry_pagination_stability"
category = "storage_postgres"
priority = "P1"
description = "Postgres registry pagination stability."
files = ["enterprise/enterprise-system-tests/tests/postgres_store.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test postgres_store -- --exact postgres_registry_pagination_stability"
artifacts = ["summary.json", "summary.md", "tool_transcript.json"]
estimated_runtime_sec = 18

[[tests]]
name = "postgres_registry_signing_metadata"
category = "storage_postgres"
priority = "P1"
description = "Postgres registry preserves signing metadata."
files = ["enterprise/enterprise-system-tests/tests/postgres_store.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test postgres_store -- --exact postgres_registry_signing_metadata"
artifacts = ["summary.json", "summary.md", "tool_transcript.json"]
estimated_runtime_sec = 18

[[tests]]
name = "s3_runpack_encryption_enforced"
category = "storage_s3"
priority = "P1"
description = "S3 server-side encryption enforced."
files = ["enterprise/enterprise-system-tests/tests/s3_runpack_store.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test s3_runpack_store -- --exact s3_runpack_encryption_enforced"
artifacts = ["summary.json", "summary.md", "tool_transcript.json"]
estimated_runtime_sec = 25

[[tests]]
name = "runpack_archive_size_limit"
category = "runpack"
priority = "P1"
description = "Runpack archive size limit enforcement."
files = ["enterprise/enterprise-system-tests/tests/s3_runpack_store.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test s3_runpack_store -- --exact runpack_archive_size_limit"
artifacts = ["summary.json", "summary.md", "tool_transcript.json"]
estimated_runtime_sec = 20

[[tests]]
name = "transport_parity_enterprise"
category = "mcp_transport"
priority = "P1"
description = "HTTP and stdio transport parity for enterprise config."
files = ["enterprise/enterprise-system-tests/tests/transport_parity.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test transport_parity -- --exact transport_parity_enterprise"
artifacts = ["summary.json", "summary.md", "tool_transcript.json", "stdio.stderr.log"]
estimated_runtime_sec = 20

[[tests]]
name = "enterprise_tls_rejects_plaintext"
category = "mcp_transport"
priority = "P1"
description = "TLS-only endpoint rejects plaintext connections."
files = ["enterprise/enterprise-system-tests/tests/transport_tls.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test transport_tls -- --exact enterprise_tls_rejects_plaintext"
artifacts = ["summary.json", "summary.md", "tool_transcript.json"]
estimated_runtime_sec = 15

[[tests]]
name = "enterprise_mtls_subject_enforced"
category = "security"
priority = "P1"
description = "mTLS subject auth rejects non-matching clients."
files = ["enterprise/enterprise-system-tests/tests/transport_tls.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test transport_tls -- --exact enterprise_mtls_subject_enforced"
artifacts = ["summary.json", "summary.md", "tool_transcript.json"]
estimated_runtime_sec = 15

[[tests]]
name = "enterprise_backup_restore_validation"
category = "recovery"
priority = "P1"
description = "Backup and restore validation for Postgres + S3."
files = ["enterprise/enterprise-system-tests/tests/backup_restore.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test backup_restore -- --exact enterprise_backup_restore_validation"
artifacts = ["summary.json", "summary.md", "tool_transcript.json"]
estimated_runtime_sec = 40

# =============================================================================
# P2: Medium Priority
# =============================================================================

[[tests]]
name = "runpack_export_temporary_cleanup"
category = "runpack"
priority = "P2"
description = "Runpack export temp directory cleanup."
files = ["enterprise/enterprise-system-tests/tests/runpack_hardening.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test runpack_hardening -- --exact runpack_export_temporary_cleanup"
artifacts = ["summary.json", "summary.md", "tool_transcript.json"]
estimated_runtime_sec = 12

[[tests]]
name = "enterprise_config_path_limits"
category = "config"
priority = "P2"
description = "Enterprise config path and file size limits enforced."
files = ["enterprise/enterprise-system-tests/tests/config_limits.rs"]
run_command = "cargo test -p enterprise-system-tests --features enterprise-system-tests --test config_limits -- --exact enterprise_config_path_limits"
artifacts = ["summary.json", "summary.md", "tool_transcript.json"]
estimated_runtime_sec = 5
