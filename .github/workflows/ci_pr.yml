name: ci-pr

on:
  pull_request:

permissions:
  contents: read

jobs:
  pr-gate:
    name: pr-gate
    runs-on: ubuntu-latest
    env:
      RUST_BACKTRACE: "1"
      CARGO_TERM_COLOR: "always"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install nightly toolchain (rustfmt)
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: nightly
          components: rustfmt
      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.92.0"
          components: rustfmt, clippy
      - name: Rust cache
        uses: Swatinem/rust-cache@v2
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install docs runner dependencies
        run: python -m pip install --upgrade pip pyyaml
      - name: Format check
        run: cargo +nightly fmt --all -- --check
      - name: Clippy
        run: cargo clippy --all-targets --all-features -D warnings
      - name: Install cargo-deny
        run: cargo install cargo-deny --locked
      - name: Cargo deny
        run: cargo deny check
      - name: Generation drift
        run: scripts/generate_all.sh --check
      - name: Unit tests
        run: cargo test --workspace --exclude system-tests
      - name: Docs run (fast)
        run: python scripts/docs_verify.py --run --level=fast

  docker-build:
    name: docker-build
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build Docker image (amd64 only)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          platforms: linux/amd64
          push: false
          tags: decision-gate:pr
